!function(t){angular.module("report.services",[]).service("ReportService",["$http","$compile","$modal","$translate",function(t,e,r,a){var o=$("body"),i=angular.element(o.get(0)).scope();this.getReport=function(e){var r={url:"api/rest/report",method:"POST",data:angular.toJson({reportName:e})};return t(r)},this.getPDF=function(e){var r={url:"api/rest/report/pdf",method:"POST",responseType:"arraybuffer",data:angular.toJson(e)};return t(r)},this.getPDFAsFile=function(e){var r={url:"api/rest/report/pdfasfile",method:"POST",data:angular.toJson(e)};return t(r)},this.getContentAsString=function(e){var r={url:"api/rest/report/contentasstring",method:"POST",data:angular.toJson(e)};return t(r)},this.openURLContent=function(t){var r=$("#reportViewContext");r.get(0)||(console.log("include[#reportViewContext]"),o.append('<div id="reportViewContext" ng-include="\'plugins/cronapp-framework-js/components/reports/reports.view.html\'"></div>'),e(o)(i));var a=function(){var e=$("<iframe/>");e.attr("frameborder",0);var o=parseInt($(window).height());e.attr("height",o-200),e.attr("width","100%"),e.attr("src",t+"?download=false");var i=$("#reportView .modal-body");i.get(0)?(i.html(e),$("#reportViewContext .modal-dialog").css("width","95%"),setTimeout(function(){console.log("open[#reportViewContext]"),$("body").append(r),$("#reportView").modal()},100)):(console.log("wait[#reportViewContext]"),setTimeout(a,200))};setTimeout(a,200)},this.initializeStimulsoft=function(t){if(!Stimulsoft.Base.StiLicense.Key){stimulsoftHelper.setLanguage(t);var e=stimulsoftHelper.getLocalization();Stimulsoft.Base.Localization.StiLocalization.loadLocalization(e.xml),Stimulsoft.Base.Localization.StiLocalization.cultureName=e.cultureName,Stimulsoft.Base.StiLicense.Key=stimulsoftHelper.getKey()}},this.openStimulsoftReport=function(t,r){var a=$("#reportViewContext");a.get(0)||(console.log("include[#reportViewContext]"),o.append('<div id="reportViewContext" ng-include="\'plugins/cronapp-framework-js/components/reports/reports.view.html\'"></div>'),e(o)(i));var n=parseInt($(window).height()),s=new Stimulsoft.Viewer.StiViewerOptions;s.appearance.scrollbarsMode=!0,s.height=n-200+"px";var l=new Stimulsoft.Viewer.StiViewer(s,"StiViewer",!1),p=new Stimulsoft.Report.StiReport;if(p.load(t),r){var u=this.getStimulsoftParams(t);r.forEach(function(t){u.forEach(function(e){for(var r=0;r<e.fieldParams.length;r++)if(e.fieldParams[r].param==t.originalName){e.fieldParams[r].value=t.value;break}})}),stimulsoftHelper.setParamsInFilter(p.dictionary.dataSources,u)}l.report=p;var m=setInterval(function(){var t=$("<div/>");t.attr("id","contentReport"),t.attr("width","100%");var e=$("#reportView .modal-body");e.get(0)&&(e.html(t),$("#reportViewContext .modal-dialog").css("width","95%"),setTimeout(function(){console.log("open[#reportViewContext]"),$("body").append(a),$("#reportView").modal(),l.renderHtml("contentReport")},100),clearInterval(m))},200)},this.showParameters=function(t){var e=t.parameters,a=[],o=0,i=function(t){return t.replace(/([.*+?^=!:()|\[\]\/\\])/g,"\\$1")},n=function(t,e,r){return t.replace(new RegExp(i(e),"g"),r)},s=function(){if(o<e.length){var i=e[o++];$.get("plugins/cronapp-framework-js/components/reports/"+i.type+".parameter.html").done(function(t){a.push(n(t,"_field_",i.name)),s()})}else a.length>0&&r.open({templateUrl:"plugins/cronapp-framework-js/components/reports/reports.parameters.html",controller:"ParameterController",resolve:{report:function(){return JSON.parse(JSON.stringify(t))},htmlParameters:function(){return JSON.parse(JSON.stringify(a))}}})}.bind(this);s()},this.mergeParam=function(t,e){for(var r in Object.keys(t)){var a=t[r].name,o=(t[r].value,function(t,e){for(var r in Object.keys(e)){if(t==Object.keys(e[r])[0])return Object.values(e[r])[0]}}(a,e));o&&(t[r].value=o)}return t},this.hasParameterWithOutValue=function(t){for(var e in Object.keys(t))if(!t[e].value)return!0;return!1},this.getStimulsoftParams=function(t){var e=new Stimulsoft.Report.StiReport;e.load(t);var r=[];if(e.pages&&e.pages.list&&e.pages.list.length>0){e.pages.toList().forEach(function(t){t.components.toList().forEach(function(t){r.push(t.dataSourceName)})})}var a=[];return r.forEach(function(t){var r=stimulsoftHelper.findDatasourceByName(e.dictionary.dataSources,t);r&&stimulsoftHelper.dataSourceHasParam(r)&&a.push({name:r.name,fieldParams:stimulsoftHelper.getParamsFromFilter(r)})}),a},this.openReport=function(t,e){this.getReport(t).then(function(t){t&&t.data&&(t.data.reportName.endsWith(".report")?(this.initializeStimulsoft(a.use()),this.getContentAsString(t.data).then(function(r){var o=this.getStimulsoftParams(r.data);o.length>0?(t.data.parameters=stimulsoftHelper.parseToGroupedParam(o),t.data.contentData=r.data,e&&(t.data.parameters=this.mergeParam(t.data.parameters,e)),this.hasParameterWithOutValue(t.data.parameters)?(t.data.parameters.forEach(function(t){t.name=a.instant(t.name)}),this.showParameters(JSON.parse(JSON.stringify(t.data)))):this.openStimulsoftReport(r.data,t.data.parameters)):this.openStimulsoftReport(r.data)}.bind(this),function(t){var e=cronapi.internal.getErrorMessage(t,t.statusText);i.Notification.error(e)}.bind(this))):0==t.data.parameters.length||1==t.data.parameters.length&&"DATA_LIMIT"==t.data.parameters[0].name?this.getPDFAsFile(t.data.reportName).then(function(t){this.openURLContent(t.data)}.bind(this),function(t){var e=cronapi.internal.getErrorMessage(t,t.statusText);i.Notification.error(e)}.bind(this)):(e&&(t.data.parameters=this.mergeParam(t.data.parameters,e)),this.hasParameterWithOutValue(t.data.parameters)?this.showParameters(JSON.parse(JSON.stringify(t.data))):this.getPDFAsFile(t.data).then(function(t){this.openURLContent(t.data)}.bind(this))))}.bind(this))}}])}(app);