(function(){angular.module("dashboard.services",[]).service("DashboardService",["$http","$compile","$modal","$translate","$window","$rootScope",function(a,b,c,d){function e(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)}function f(a){window.open(a,"_blank")}var g=$("body"),i=angular.element(g.get(0)).scope(),j=["node_modules/cronapp-lib-js/dist/js/stimulsoft/stimulsoft-all.js","node_modules/cronapp-lib-js/dist/js/stimulsoft/stimulsoft-helper.js"],k=[];this.getDashboard=function(b){var c={url:"api/rest/dashboard",method:"POST",data:angular.toJson({dashboardName:b})};return a(c)},this.getContentAsString=function(b){var c={url:"api/rest/dashboard/contentasstring",method:"POST",data:angular.toJson(b)};return a(c)},this.openURLContent=function(a){if(a&&e())return void f(a);var b=function(){var c=$("<iframe/>");c.attr("frameborder",0);var d=parseInt($(window).height());c.attr("height",d-200),c.attr("width","100%"),c.attr("src",a+"?download=false");var e=$("#reportView .modal-body");e.get(0)?(e.html(c),$("#reportViewContext .modal-dialog").css("width","95%"),setTimeout(function(){console.log("open[#reportViewContext]"),$("body").append(context),$("#reportView").modal()},100)):(console.log("wait[#reportViewContext]"),setTimeout(b,200))};setTimeout(b,200)},this.initializeStimulsoft=function(a){if(!Stimulsoft.Base.StiLicense.Key){stimulsoftHelper.setLanguage(a);var b=stimulsoftHelper.getLocalization();Stimulsoft.Base.Localization.StiLocalization.loadLocalization(b.xml),Stimulsoft.Base.Localization.StiLocalization.cultureName=b.cultureName,Stimulsoft.Base.StiLicense.Key=stimulsoftHelper.getKey()}},this.openStimulsoftReport=function(a,c,d){var j=$("#dashboardViewContext");j.get(0)||(g.append("<div id=\"dashboardViewContext\" ng-include=\"'node_modules/cronapp-framework-js/components/dashboard/dashboard.view.html'\"></div>"),b(g)(i),j=$("#dashboardViewContext"));var k=parseInt($(window).height()),h="StiViewer"+app.common.generateId(),l=Stimulsoft.Report.StiReport.createNewDashboard();l.load(a);var m=()=>{var a=new Stimulsoft.Viewer.StiViewerOptions;a.toolbar.showAboutButton=!1,d?(a.toolbar.visible=d.showToolbar,a.appearance.scrollbarsMode=d.showScrollbar,null!=d.height&&(a.height=d.height+"px")):(a.appearance.scrollbarsMode=!0,a.height=k-200+"px");var b=new Stimulsoft.Viewer.StiViewer(a,h,!1);return b.report=l,b};if(d&&d.$element)m(d).renderHtml(d.$element[0]);else{function a(){var a,b,c,d,e,f=setInterval(function(){var g=$("#"+h);g.length?!a&&(a=g.parent(),b=a.parent(),c=b.parent(),d=c.parent(),e=d.parent()):(console.log("cleared interval: "+h),clearInterval(f))},100)}(function(b){if(b&&e())return void f(b);var c=setInterval(function(){var b=$("<div/>");b.attr("id","contentDashboard"),b.attr("width","100%");var e=$("#dashboardView .modal-body");e.get(0)&&(e.html(b),$("#dashboardViewContext .modal-dialog").css("width","95%"),setTimeout(function(){console.log("open[#dashboardViewContext]"),$("body").append(j),cronapi.screen.showModal("dashboardView"),m(d).renderHtml("contentDashboard"),setTimeout(function(){a()},100)},100),clearInterval(c))},200)})(null)}$(`#${h}`).find("img").attr("alt",""),$(`#${h}`).find("input").attr("aria-label",h)},this.loadSriptsStimulsoft=function(a){var b=!0,c=j.length,d=0;Pace.options.initialRate=.7,Pace.options.minTime=1750,Pace.options.maxProgressPerFrame=1,Pace.options.ghostTime=12e4;let e=setInterval(()=>Pace.restart(),2500);j.forEach(function(f){this.loadScript(f,function(f){d++,f||(b=!1),d==c&&(clearInterval(e),Pace.options.initialRate=.03,Pace.options.minTime=250,Pace.options.maxProgressPerFrame=20,Pace.options.ghostTime=10,Pace.stop(),a(b))})}.bind(this))},this.loadScript=function(a,b){if(0<=$.inArray(a,k))return void(b&&b(!0));if(-1!=a.indexOf(".css")){var c=document.createElement("link");c.rel="stylesheet",c.type="text/css",c.href=a,c.media="all",c.onload=function(){k.push(a),b&&b(!0)},c.onerror=function(){b&&b(!1)};try{document.getElementsByTagName("head")[0].appendChild(c)}catch(a){console.log(a)}}else{var d=document.createElement("script");d.type="text/javascript",d.readyState?d.onreadystatechange=function(){("loaded"==d.readyState||"complete"==d.readyState)&&(d.onreadystatechange=null,k.push(a),b&&b(!0))}:d.onload=function(){k.push(a),b&&b(!0)},d.src=a,document.getElementsByTagName("head")[0].appendChild(d)}},this.openDashboard=function(a,b,c){this.getDashboard(a).then(function(a){a&&a.data&&a.data.dashboardName.endsWith(".dashboard")&&this.loadSriptsStimulsoft(function(b){b?(this.initializeStimulsoft(d.use()),this.getContentAsString(a.data).then(function(b){this.openStimulsoftReport(b.data,a.data.parameters,a.data.datasourcesInBand,c)}.bind(this),function(a){var b=cronapi.internal.getErrorMessage(a,a.statusText);i.Notification.error(b)}.bind(this))):i.Notification.error("Error loading report script")}.bind(this))}.bind(this))}}])})(app);